<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Civic Issue Reporter</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f2f2f2;
    }
    h2 {
      text-align: center;
      color: #333;
    }
    .upload-section {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 30px;
      max-width: 500px;
      margin: auto;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
    }
    .issue-post {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      margin: 20px auto;
      max-width: 500px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .issue-post img {
      width: 100%;
      height: auto;
      border-radius: 5px;
    }
    .timer, .meta {
      font-size: 14px;
      color: #666;
      margin-top: 8px;
    }
  </style>
</head>
<body>

  <h2>Report a Civic Issue</h2>

  <div class="upload-section">
    <input type="file" id="imageUpload" accept="image/*">
    <br>
    <button onclick="uploadIssue()">Post Issue</button>
  </div>

  <div id="postsContainer"></div>

  <script>
    function timeSince(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      const intervals = [
        { label: 'year', seconds: 31536000 },
        { label: 'month', seconds: 2592000 },
        { label: 'day', seconds: 86400 },
        { label: 'hour', seconds: 3600 },
        { label: 'minute', seconds: 60 },
      ];
      for (let i = 0; i < intervals.length; i++) {
        const interval = Math.floor(seconds / intervals[i].seconds);
        if (interval >= 1) {
          return interval + ' ' + intervals[i].label + (interval > 1 ? 's' : '') + ' ago';
        }
      }
      return 'just now';
    }

    function updateTimers() {
      document.querySelectorAll('.issue-post').forEach(post => {
        const timestamp = post.getAttribute('data-timestamp');
        const timeSpan = post.querySelector('.time-since');
        timeSpan.textContent = timeSince(new Date(timestamp));
      });
    }

    function getLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject('Geolocation not supported');
        } else {
          navigator.geolocation.getCurrentPosition(async position => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
            const data = await res.json();

            const city = data.address.city || data.address.town || data.address.village || 'Unknown';
            const country = data.address.country || 'Unknown';

            resolve(`${city}, ${country}`);
          }, () => {
            reject('Location permission denied');
          });
        }
      });
    }

    async function uploadIssue() {
      const fileInput = document.getElementById('imageUpload');
      const file = fileInput.files[0];

      if (!file) {
        alert('Please upload an image.');
        return;
      }

      let location = 'Unknown';
      try {
        location = await getLocation();
      } catch (err) {
        alert('Could not get location: ' + err);
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const imageUrl = e.target.result;
        const timestamp = new Date().toISOString();
        const postedDate = new Date(timestamp).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' });

        const postHTML = `
          <div class="issue-post" data-timestamp="${timestamp}">
            <img src="${imageUrl}" alt="Issue Image" onclick="incrementViews(this)">
            <div class="timer">Posted: <span class="time-since">just now</span> | ${postedDate}</div>
            <div class="meta">Location: ${location}</div>
            <div class="meta views"> Views: <span class="view-count">0</span></div>
          </div>
        `;

        const container = document.getElementById('postsContainer');
        container.insertAdjacentHTML('afterbegin', postHTML);

        fileInput.value = '';
        updateTimers();
      };

      reader.readAsDataURL(file);
    }

    function incrementViews(imgElement) {
      const post = imgElement.closest('.issue-post');
      const viewSpan = post.querySelector('.view-count');
      let current = parseInt(viewSpan.textContent);
      viewSpan.textContent = current + 1;
    }

    setInterval(updateTimers, 60000);
    updateTimers();
  </script>

</body>
</html>
